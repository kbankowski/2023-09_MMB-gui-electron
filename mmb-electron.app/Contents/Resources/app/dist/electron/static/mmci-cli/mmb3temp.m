%% Pre-amble
clear all; close all; clc
[projectPath, subProjectPath, projectPathFimod] = init();

%%
mmb('config_2.json','var');

%% values simulated with simult_ Dynare function
% the major advantage of this approach is that one can
% explicitely see both ss values and shock-simulated values

% creating shocks
ex_ = databank.fromArray( ...
    zeros(20, length(M_.exo_names)) ...
    , M_.exo_names ...
    , qq(1, 1) ...
);
ex_.interest_(qq(1, 1)) = 1;

% stochastic simulation
y_ = simult_( ...
    M_ ...
    , options_ ...
    , oo_.steady_state ...
    , oo_.dr ...
    , databank.toArray(ex_) ...
    , 1 ...
);

% stochastic simulation, SS and deviations as databanks
aSeriesY_ = databank.fromArray( ...
    y_' ...
    , M_.endo_names ...
    , qq(1, 1)-1: qq(5, 4) ...
);
aSeriesSS = databank.fromArray( ...
    repmat(oo_.steady_state', 21, 1) ...
    , M_.endo_names ...
    , qq(1, 1)-1: qq(5, 4) ...
);
aSeriesSimult = dbfun(@(x, y) x - y, aSeriesY_, aSeriesSS);

%% values simulated with Dynare irf function
SS(M_.exo_names_orig_ord,M_.exo_names_orig_ord)=M_.Sigma_e+1e-14*eye(M_.exo_nbr);
cs = eye(size(SS,1));
irf_ = irf( ...
    M_ ...
    , options_ ...
    , oo_.dr ...
    , cs(M_.exo_names_orig_ord, strcmp(M_.exo_names, 'interest_')) ...
    , options_.irf ...
    , options_.drop ...
    , options_.replic ...
    , options_.order ...
);

% deviations as databanks
aSeriesIrf = databank.fromArray( ...
    irf_' ...
    , M_.endo_names ...
    , qq(1, 1): qq(5, 4) ...
);

%% values simulated with MMB
% reading in the json file produced with the mmb('config_2.json','var')
% command
fname = fullfile(projectPath, subProjectPath, 'out', 'ESREA_FIMOD12-Model.output.json'); 
fid = fopen(fname); 
raw = fread(fid,inf); 
str = char(raw'); 
fclose(fid); 
val = jsondecode(str);

% deviations as a databank
for aSer = string(reshape(fieldnames(val.data.IRF.interest_), 1, []))
    mmbSim.(aSer) = Series(qq(0, 4), val.data.IRF.interest_.(aSer));
end

%% values coming from FiMod project
matFilePath = fullfile(projectPathFimod, "FiMod/Output/FiMod_results.mat");
aDataFiMod = load(matFilePath);

aSeriesFiMod = databank.fromArray( ...
    cell2mat(struct2cell(aDataFiMod.oo_.irfs))' ...
    , extractBefore(databank.fieldNames(aDataFiMod.oo_.irfs), "_epsii") ...
    , qq(1) ...
);

%% comparing the results
close all
tempMat = [aSeriesSimult.interest, aSeriesIrf.interest, mmbSim.interest, aSeriesFiMod.interestEA]
figure(1)
plot(tempMat)

tempMat = [aSeriesSimult.output, aSeriesIrf.output, mmbSim.output, aSeriesFiMod.outputEA]
figure(2)
plot(tempMat)

tempMat = [aSeriesSimult.inflationq, aSeriesIrf.inflationq, mmbSim.inflationq, aSeriesFiMod.inflationqEA]
figure(3)
plot(tempMat)

tempMat = [aSeriesSimult.inflation, aSeriesIrf.inflation, mmbSim.inflation, aSeriesFiMod.inflationEA]
figure(4)
plot(tempMat)

